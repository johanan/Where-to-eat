/*! Where-to-eat - v0.8.0 - 2015-01-08
* Copyright (c) 2015 ; Licensed  */
var UserImage=React.createClass({usernameToImg:function(a){var b,c,d,e=new RegExp("^(fb:)?"),f=a.split(e);if(f.length>1?(b=f[f.length-2],d=f[f.length-1]):(d=a,b="gravatar"),b&&"fb:"===b)c="https://graph.facebook.com/"+d+"/picture?type=square";else{var g=md5(d.toLowerCase());c="http://www.gravatar.com/avatar/"+g+"?d=retro&s=18"}return{src:c,username:d}},render:function(){var a=this.usernameToImg(this.props.username),b=this.props.useName?a.username+": ":null;return React.DOM.span(null,[React.DOM.img({src:a.src,className:"userimg",title:a.username,ref:"userImage"},null),b])}}),UserDisplay=React.createClass({signoutUser:function(){$(window).trigger("SignoutUser")},handleClick:function(a){a.preventDefault(),this.signoutUser()},render:function(){return React.DOM.div(null,[React.createElement(UserImage,{username:this.props.username,useName:!0}),React.DOM.a({href:"#",onClick:this.handleClick},"Sign out")])}}),UserLogin=React.createClass({addUser:function(a){$(window).trigger("AddUser",a)},handleBlur:function(a){var b=a.target.value;""!==b&&this.addUser(b)},render:function(){return React.DOM.input({id:"login",type:"text",placeholder:"fb:username or gravatar",onBlur:this.handleBlur},null)}}),LoginForm=React.createClass({processUser:function(a){var b=void 0!==a&&null!==a,c=null;return b&&(c=a),{loggedIn:b,user:c}},render:function(){var a=this.processUser(this.props.user),b=a.loggedIn?React.createElement(UserDisplay,{username:this.props.user.username}):React.createElement(UserLogin,null);return React.DOM.div(null,[b])}}),RestaurantWell=React.createClass({restaurantSearch:function(a){$(window).trigger("RestaurantSearch",a)},clearRestaurantSearch:function(){$(window).trigger("ClearRestaurantSearch")},searchClickHandler:function(a){a.preventDefault();var b=this.refs.restSearch.getDOMNode().value;this.restaurantSearch(""!==b?b:"restaurant")},clearClickHandler:function(a){a.preventDefault(),this.clearRestaurantSearch(),this.refs.restSearch.getDOMNode().value=""},render:function(){return React.DOM.form({className:"form-search",onSubmit:this.searchClickHandler},[React.DOM.input({type:"text",className:"input-medium search-query",placeholder:"search or leave blank",ref:"restSearch"},null),React.DOM.button({className:"btn",onClick:this.searchClickHandler},React.DOM.i({className:"icon-search"},null)),React.DOM.button({className:"btn",onClick:this.clearClickHandler},React.DOM.i({className:"icon-remove"},null))])}}),RestaurantDisplay=React.createClass({vote:function(a){$(window).trigger("Vote",a)},handleClick:function(a){a.preventDefault(),this.vote(this.props.fs)},render:function(){var a,b,c,d,e=this.props.fs,f=[];return a=e.categories.length>0?React.DOM.img({src:e.categories[0].icon.prefix+"bg_32"+e.categories[0].icon.suffix},null):React.DOM.img({src:"images/marker.png"},null),b=void 0!==e.phone?React.DOM.div(null,e.phone):null,c=void 0!==e.menu?React.DOM.div(null,React.DOM.a({href:e.menu.url,target:"_blank"},"Menu")):null,void 0!==e.user?(d=React.DOM.div(null,"Votes: "+e.user.length),f=e.user.slice()):d=React.DOM.div(null,"Votes: 0"),React.DOM.div(null,[React.DOM.h3(null,a,e.name),b,c,d,React.DOM.div(null,f.map(function(a){return React.createElement(UserImage,{username:a.username,useName:!1})})),React.DOM.button({className:"btn",onClick:this.handleClick},"Vote for "+e.name)])}}),VoteDisplay=React.createClass({showRestaurant:function(a){$(window).trigger("ShowRestaurant",a)},handleClick:function(a,b){this.showRestaurant(this.props.votes[b][2])},render:function(){var a=function(a,b){return function(c){return a(c,b)}};return React.DOM.ul({id:"votes"},this.props.votes.map(function(b,c){return React.DOM.li(null,[React.DOM.div({onClick:a(this.handleClick,c)},b[3].length+" for "+b[0]),b[3].map(function(a){return React.createElement(UserImage,{username:a.username,useName:!1})})])}.bind(this)))}}),ActivityDisplay=React.createClass({componentWillMount:function(){this.boundAddVote=this.addVote.bind(this),$(window).on("ServerVote.React",this.boundAddVote)},getInitialState:function(){return{votes:[]}},addVote:function(a,b){var c=this.state.votes.slice();c.push(b),this.setState({votes:c})},showRestaurant:function(a){$(window).trigger("ShowRestaurant",a)},handleClick:function(a){this.showRestaurant(this.state.votes[a].id)},componentWillUnmount:function(){$(window).off("ServerVote.React",this.boundAddVote)},render:function(){return React.DOM.ul({id:"acts"},this.state.votes.map(function(a,b){return React.DOM.li({key:b},[React.DOM.div({onClick:this.handleClick.bind(this,b)},React.createElement(UserImage,{username:a.user.username,useName:!1}),a.user.username+" voted for "+a.name),React.DOM.hr(null,null)])}.bind(this)))}});!function(a){"use strict";a.Cookie={},a.Cookie.createCookie=function(a,b,c){var d;if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toGMTString()}else d="";document.cookie=a+"="+b+d+"; path=/"},a.Cookie.readCookie=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b))return e.substring(b.length,e.length)}return null},a.Cookie.eraseCookie=function(b){a.Cookie.createCookie(b,"",-1)}}(window.Josh=window.Josh||{}),function(a,b){"use strict";var c,d=[];a.Socket=function(a){return e(a)};var e=function(a){c=a;var e=function(a,e){var f=function(c){b(e).trigger(a,c)};c.on(a,f),d.push({name:a,func:f})},f=function(a,b,d){c.emit("add",a,b,function(){d()})},g=function(a){var d=b.extend(!0,{},a);delete d.marker,delete d.user,c.emit("addVote",d)},h=function(){c.emit("get")},i=function(){c.emit("getVotes")},j=function(){for(var a=0;a<d.length;a++)c.removeListener(d[a].name,d[a].func)};return{addEvent:e,addUser:f,addVote:g,getUsers:h,getVotes:i,removeListeners:j}}}(window.Josh=window.Josh||{},window.jQuery),function(a){"use strict";a.User=function(a){this.username=a}}(window.Josh=window.Josh||{}),function(a,b){"use strict";var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;a.Map=function(u){h=function(){},i=document.getElementById("fsRest"),c=document.getElementById("acts"),t=document.getElementById("votes"),g=document.getElementById("loginArea"),l=document.getElementById("search"),m=b("#searchText"),n=new a.Socket(io.connect("http://"+location.host+"/users")),o=new L.StamenTileLayer("toner-lite"),f=document.getElementById("clear"),s=b("#title"),d=b("#alert"),k=document.getElementById("restSearch"),p=document.getElementById("tab1"),q=document.getElementById("tab2"),r=this,j=L.Icon.extend({options:{shadowUrl:null,iconSize:new L.Point(32,32)}}),this.currentFSID=null,this.currentUser=null,this.location=null,this.map=new L.Map(u,{zoomAnimation:!0}),this.map.addLayer(o),this.searchFs={},this.searchLayer=null,this.voteFs=new a.Votes,navigator.geolocation.getCurrentPosition(function(a){r.centerLoc(a)},h,{timeout:1e4}),b(window).on("Vote.Map",function(a,b){null!==r.currentUser?n.addVote(b):r.addAlert("You must be logged in!")}),b(window).on("ShowRestaurant.Map",function(a,b){r.showRest(b)}),b(window).on("AddUser.Map",function(a,b){r.addUser(b)}),b(window).on("SignoutUser.Map",function(){r.removeUser()}),b(window).on("RestaurantSearch.Map",function(a,b){r.addAlert("Searching for Restaurants"),r.findRests(b),r.removeAlert()}),b(window).on("ClearRestaurantSearch.Map",function(){r.addSearchLayer({})}),d.on("click",function(){r.removeAlert()}),b(this.voteFs).on("removeLayer",function(a,b){r.removeLayer(b)}),window.addEventListener("hashchange",function(){window.location.reload()}),n.addEvent("serverError",this),b(this).on("serverError",function(a,b){this.addAlert(b.message)}),n.addEvent("vote",this),b(this).on("vote",function(c,d){if(void 0===this.voteFs.votes[d.fs.id]){var e=this.addMarker(d.fs);d.fs.marker=e}var f=new a.User(d.username);d.fs.user=[f],b(window).trigger("ServerVote",{name:d.fs.name,user:f,id:d.fs.id}),this.voteFs.addVote(d.fs),this.showVotes()}),window.location.hash?(e=String(window.location.hash).slice(1),s.html(e)):e="default";var v=a.Cookie.readCookie("username");null!==v?this.addUser(v):React.render(React.createElement(LoginForm,null),b(g)[0]),React.render(React.createElement(RestaurantWell,null),k),React.render(React.createElement(ActivityDisplay,null),q)},a.Map.prototype={addAlert:function(a){d.removeClass("none"),d.html(a)},addMarker:function(a,b){b="undefined"!=typeof b?b:!0;var c;c=a.categories.length>0?new j({iconUrl:a.categories[0].icon.prefix+"bg_32"+a.categories[0].icon.suffix}):new L.Icon({iconUrl:"images/marker.png"});var d=new L.LatLng(a.location.lat,a.location.lng),e=new L.Marker(d,{icon:c,title:a.name});return e.fsid=a.id,e.img=c.iconUrl,e.on("click",this.showRestProxy.bind(this)),b&&this.map.addLayer(e),e},addSearchFs:function(a){this.searchFs[a.id]=a},addSearchLayer:function(a){null!==this.searchLayer&&this.removeLayer(this.searchLayer),this.searchLayer=new L.LayerGroup;for(var b in a){this.addSearchFs(a[b]);var c=this.addMarker(a[b],!1);this.searchLayer.addLayer(c)}this.map.addLayer(this.searchLayer)},addUser:function(c){""!==c&&(React.render(React.createElement(LoginForm,{user:{username:c}}),b(g)[0]),a.Cookie.createCookie("username",c),this.currentUser=new a.User(c),n.addUser(c,e,function(){n.getVotes()}))},centerLoc:function(a){this.location=a;var b=new L.LatLng(this.location.coords.latitude,this.location.coords.longitude);this.map.setView(b,13)},findFs:function(a){return this.voteFs.votes[a]?this.voteFs.votes[a]:this.searchFs[a]},findRests:function(a){a=encodeURI(""!==a?a:"restaurant");var c=b.getJSON("/foursquare?lat="+this.location.coords.latitude+"&lon="+this.location.coords.longitude+"&query="+a);c.done(function(a){var b=a.response.venues;this.addSearchLayer(b)}.bind(this))},removeAlert:function(){d.addClass("none")},removeLayer:function(a){if(void 0!==a.getLayers)for(var b=a.getLayers(),c=0;c<b.length;c++)this.removeMarker(b[c]);this.map.removeLayer(a)},removeMarker:function(a){a.clearAllEventListeners()},removeUser:function(){a.Cookie.eraseCookie("username"),a.Cookie.eraseCookie("img"),this.currentUser=null,React.render(React.createElement(LoginForm,null),b(g)[0])},showRest:function(a){var b=this.findFs(a);this.currentFSID=a,React.render(React.createElement(RestaurantDisplay,{fs:b}),i)},showRestProxy:function(a){this.showRest(a.target.fsid)},showVotes:function(){var a=[];for(var b in this.voteFs.votes)a.push([this.voteFs.votes[b].name,this.voteFs.votes[b].user.length,this.voteFs.votes[b].id,this.voteFs.votes[b].user]);a.sort(function(a,b){return b[1]-a[1]});for(var c=0;c<a.length;c++)this.currentFSID===a[c][2]&&this.showRest(a[c][2]);React.render(React.createElement(VoteDisplay,{votes:a}),p)}}}(window.Josh=window.Josh||{},window.jQuery),function(a,b){"use strict";a.Votes=function(){this.votes={},this.users={}},a.Votes.prototype={addVote:function(a){var b=this.findByUser(a.user[0].username);if(void 0!==b){var c=this.findByFs(b);c.user=this.removeFromArray(a.user[0].username,c.user)}this.users[a.user[0].username]=a.id;var d=this.findByFs(a.id);void 0===d?(this.votes[a.id]=a,d=a):d.user.push(a.user[0]),this.cleanUpRestaurants()},cleanUpRestaurants:function(){for(var a in this.votes)0===this.votes[a].user.length&&(b(this).trigger("removeLayer",this.votes[a].marker),delete this.votes[a])},findByFs:function(a){return this.votes[a]},findByUser:function(a){return this.users[a]},removeFromArray:function(a,b){for(var c=[],d=0;d<b.length;d++)b[d].username!==a&&c.push(b[d]);return c}}}(window.Josh=window.Josh||{},window.jQuery);